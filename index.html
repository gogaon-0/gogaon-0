<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Bot Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); color: #fff; min-height: 100vh; }
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .login-box { max-width: 450px; width: 100%; text-align: center; }
        .login-icon { width: 80px; height: 80px; background: #5865F2; border-radius: 20px; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 20px; font-size: 40px; }
        .login-card { background: rgba(30, 30, 30, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 40px; }
        .discord-btn { width: 100%; background: #5865F2; color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .discord-btn:hover { background: #4752C4; transform: scale(1.02); }
        .discord-btn svg { width: 24px; height: 24px; }
        .config-notice { background: rgba(88, 101, 242, 0.2); border: 1px solid #5865F2; border-radius: 10px; padding: 15px; margin-top: 20px; text-align: left; font-size: 13px; }
        .config-notice h4 { margin-bottom: 10px; color: #5865F2; }
        .config-notice code { background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .server-select-container { display: none; }
        .navbar { background: rgba(30, 30, 30, 0.95); border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; }
        .nav-brand { display: flex; align-items: center; gap: 15px; font-size: 20px; font-weight: bold; }
        .nav-icon { width: 40px; height: 40px; background: #5865F2; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: #5865F2; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .logout-btn { background: transparent; border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .logout-btn:hover { background: rgba(255, 255, 255, 0.1); }
        .content { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }
        .page-header { margin-bottom: 40px; }
        .page-title { font-size: 36px; font-weight: bold; margin-bottom: 10px; }
        .page-subtitle { color: #b9bbbe; font-size: 16px; }
        .server-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .server-card { background: rgba(30, 30, 30, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 30px; cursor: pointer; transition: all 0.3s; }
        .server-card:hover { border-color: #5865F2; transform: translateY(-5px); box-shadow: 0 10px 30px rgba(88, 101, 242, 0.3); }
        .server-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .server-icon { width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 28px; overflow: hidden; }
        .server-icon img { width: 100%; height: 100%; object-fit: cover; }
        .server-info h3 { font-size: 20px; margin-bottom: 5px; }
        .online-badge { display: flex; align-items: center; gap: 5px; color: #43b581; font-size: 14px; }
        .online-dot { width: 8px; height: 8px; background: #43b581; border-radius: 50%; }
        .server-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .bot-status { font-size: 12px; padding: 4px 10px; border-radius: 12px; }
        .bot-status.active { background: rgba(67, 181, 129, 0.2); color: #43b581; }
        .bot-status.inactive { background: rgba(237, 66, 69, 0.2); color: #ed4245; }
        .dashboard-container { display: none; }
        .dashboard-layout { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: rgba(30, 30, 30, 0.95); border-right: 1px solid rgba(255, 255, 255, 0.1); display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .selected-server { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .selected-server-icon { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 20px; overflow: hidden; }
        .selected-server-icon img { width: 100%; height: 100%; object-fit: cover; }
        .change-server-btn { width: 100%; background: rgba(255, 255, 255, 0.1); border: none; color: white; padding: 10px; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .sidebar-menu { flex: 1; padding: 20px; overflow-y: auto; }
        .menu-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; color: #b9bbbe; cursor: pointer; transition: all 0.3s; }
        .menu-item:hover { background: rgba(255, 255, 255, 0.05); color: white; }
        .menu-item.active { background: #5865F2; color: white; }
        .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .main-content { flex: 1; overflow-y: auto; background: #1a1a2e; }
        .content-area { padding: 40px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: rgba(30, 30, 30, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 25px; transition: all 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-value { font-size: 32px; font-weight: bold; margin: 10px 0; }
        .stat-label { color: #b9bbbe; font-size: 14px; }
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .chart-card { background: rgba(30, 30, 30, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 25px; }
        .chart-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; }
        .settings-section { display: none; }
        .settings-section.active { display: block; }
        .setting-card { background: rgba(30, 30, 30, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 25px; margin-bottom: 20px; }
        .setting-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .setting-info h3 { font-size: 18px; margin-bottom: 5px; }
        .setting-info p { color: #b9bbbe; font-size: 14px; }
        .toggle-switch { position: relative; width: 50px; height: 26px; background: #4e5058; border-radius: 13px; cursor: pointer; transition: all 0.3s; }
        .toggle-switch.active { background: #43b581; }
        .toggle-slider { position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: all 0.3s; }
        .toggle-switch.active .toggle-slider { transform: translateX(24px); }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: #b9bbbe; font-size: 14px; font-weight: 600; }
        .form-select { width: 100%; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 12px 15px; color: white; font-size: 14px; }
        .slider-container { margin: 20px 0; }
        .slider { width: 100%; }
        .slider-labels { display: flex; justify-content: space-between; margin-top: 8px; color: #b9bbbe; font-size: 12px; }
        .slider-value { color: #5865F2; font-weight: bold; }
        .save-btn { background: #5865F2; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .save-btn:hover { background: #4752C4; }
        .hidden { display: none; }
        .loading { display: flex; align-items: center; justify-content: center; min-height: 200px; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #5865F2; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <div class="login-icon">âš¡</div>
            <h1 style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">Discord Bot</h1>
            <p style="color: #b9bbbe; margin-bottom: 30px;">ì˜¬ì¸ì› ë´‡ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</p>
            <div class="login-card">
                <h2 style="font-size: 24px; margin-bottom: 30px;">ë¡œê·¸ì¸</h2>
                <button class="discord-btn" onclick="loginWithDiscord()">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                    </svg>
                    Discordë¡œ ë¡œê·¸ì¸
                </button>
                <div class="config-notice">
                    <h4>âš™ï¸ ì„¤ì • í•„ìš”</h4>
                    <p style="margin-bottom: 8px;">ì‹¤ì œ ì‚¬ìš©ì„ ìœ„í•´ ì•„ë˜ ê°’ì„ ì„¤ì •í•˜ì„¸ìš”:</p>
                    <p><code>CLIENT_ID</code> - Discord ì•± Client ID</p>
                    <p><code>REDIRECT_URI</code> - ì½œë°± URL</p>
                </div>
            </div>
        </div>
    </div>

    <div class="server-select-container" id="serverSelectPage">
        <nav class="navbar">
            <div class="nav-brand">
                <div class="nav-icon">âš¡</div>
                <span>Discord Bot Dashboard</span>
            </div>
            <div class="user-info">
                <span id="userName">ì‚¬ìš©ì</span>
                <div class="user-avatar" id="userAvatar">ğŸ‘¤</div>
                <button class="logout-btn" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </nav>
        <div class="content">
            <div class="page-header">
                <h1 class="page-title">ì„œë²„ ì„ íƒ</h1>
                <p class="page-subtitle">ê´€ë¦¬í•  ì„œë²„ë¥¼ ì„ íƒí•˜ì„¸ìš” (ê´€ë¦¬ì ê¶Œí•œì´ ìˆëŠ” ì„œë²„ë§Œ í‘œì‹œë©ë‹ˆë‹¤)</p>
            </div>
            <div class="server-grid" id="serverGrid">
                <div class="loading"><div class="loading-spinner"></div></div>
            </div>
        </div>
    </div>

    <div class="dashboard-container" id="dashboardPage">
        <div class="dashboard-layout">
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="selected-server">
                        <div class="selected-server-icon" id="selectedServerIcon">ğŸ’»</div>
                        <div>
                            <h3 id="selectedServerName" style="font-size: 16px;">ì„œë²„</h3>
                            <p id="selectedServerMembers" style="font-size: 12px; color: #b9bbbe;">0 ë©¤ë²„</p>
                        </div>
                    </div>
                    <button class="change-server-btn" onclick="goBackToServerSelect()">ì„œë²„ ë³€ê²½</button>
                </div>
                <div class="sidebar-menu">
                    <div class="menu-item active" onclick="changeSection('dashboard', this)">
                        <span>ğŸ </span><span>ëŒ€ì‹œë³´ë“œ</span>
                    </div>
                    <div class="menu-item" onclick="changeSection('welcome', this)">
                        <span>ğŸ’¬</span><span>í™˜ì˜ ë©”ì‹œì§€</span>
                    </div>
                    <div class="menu-item" onclick="changeSection('moderation', this)">
                        <span>ğŸ›¡ï¸</span><span>ëª¨ë”ë ˆì´ì…˜</span>
                    </div>
                    <div class="menu-item" onclick="changeSection('music', this)">
                        <span>ğŸµ</span><span>ìŒì•…</span>
                    </div>
                </div>
                <div class="sidebar-footer">
                    <button class="logout-btn" style="width: 100%;" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>

            <div class="main-content">
                <div class="content-area">
                    <div class="settings-section active" id="sectionDashboard">
                        <div class="page-header">
                            <h1 class="page-title">ëŒ€ì‹œë³´ë“œ</h1>
                            <p class="page-subtitle">ì„œë²„ í†µê³„</p>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div style="font-size: 24px;">ğŸ‘¥</div>
                                <div class="stat-value" id="totalMembers">-</div>
                                <div class="stat-label">ì´ ë©¤ë²„</div>
                            </div>
                            <div class="stat-card">
                                <div style="font-size: 24px;">âš¡</div>
                                <div class="stat-value" id="onlineMembers">-</div>
                                <div class="stat-label">ì˜¨ë¼ì¸</div>
                            </div>
                            <div class="stat-card">
                                <div style="font-size: 24px;">ğŸ’¬</div>
                                <div class="stat-value" id="totalChannels">-</div>
                                <div class="stat-label">ì±„ë„</div>
                            </div>
                            <div class="stat-card">
                                <div style="font-size: 24px;">âš™ï¸</div>
                                <div class="stat-value" id="totalRoles">-</div>
                                <div class="stat-label">ì—­í• </div>
                            </div>
                        </div>
                        <div class="chart-grid">
                            <div class="chart-card">
                                <h3 class="chart-title">ë©”ì‹œì§€ í†µê³„</h3>
                                <canvas id="chart1"></canvas>
                            </div>
                            <div class="chart-card">
                                <h3 class="chart-title">ë©¤ë²„ ì„±ì¥</h3>
                                <canvas id="chart2"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section" id="sectionWelcome">
                        <div class="page-header">
                            <h1 class="page-title">í™˜ì˜ ë©”ì‹œì§€</h1>
                            <p class="page-subtitle">ìƒˆ ë©¤ë²„ í™˜ì˜ ì„¤ì •</p>
                        </div>
                        <div class="setting-card">
                            <div class="setting-header">
                                <div class="setting-info">
                                    <h3>í™˜ì˜ ë©”ì‹œì§€ í™œì„±í™”</h3>
                                    <p>ìƒˆ ë©¤ë²„ê°€ ì…ì¥í•˜ë©´ í™˜ì˜ ë©”ì‹œì§€ë¥¼ ë³´ëƒ…ë‹ˆë‹¤</p>
                                </div>
                                <div class="toggle-switch active" onclick="doToggleSwitch(this)">
                                    <div class="toggle-slider"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">í™˜ì˜ ì±„ë„</label>
                                <select class="form-select" id="welcomeChannel"></select>
                            </div>
                            <button class="save-btn" onclick="doSaveSettings()">ì €ì¥</button>
                        </div>
                    </div>

                    <div class="settings-section" id="sectionModeration">
                        <div class="page-header">
                            <h1 class="page-title">ëª¨ë”ë ˆì´ì…˜</h1>
                            <p class="page-subtitle">ì„œë²„ ê´€ë¦¬ ì„¤ì •</p>
                        </div>
                        <div class="setting-card">
                            <div class="setting-header">
                                <div class="setting-info">
                                    <h3>ìë™ ëª¨ë”ë ˆì´ì…˜</h3>
                                    <p>ìŠ¤íŒ¸ ë° ìš•ì„¤ ìë™ ì°¨ë‹¨</p>
                                </div>
                                <div class="toggle-switch active" onclick="doToggleSwitch(this)">
                                    <div class="toggle-slider"></div>
                                </div>
                            </div>
                            <button class="save-btn" onclick="doSaveSettings()">ì €ì¥</button>
                        </div>
                    </div>

                    <div class="settings-section" id="sectionMusic">
                        <div class="page-header">
                            <h1 class="page-title">ìŒì•… ì„¤ì •</h1>
                            <p class="page-subtitle">ìŒì•… ë´‡ ì„¤ì •</p>
                        </div>
                        <div class="setting-card">
                            <div class="slider-container">
                                <label class="form-label">ê¸°ë³¸ ë³¼ë¥¨</label>
                                <input type="range" class="slider" min="0" max="100" value="75" oninput="doUpdateSlider(this)">
                                <div class="slider-labels">
                                    <span>0%</span>
                                    <span class="slider-value" id="volumeValue">75%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                            <button class="save-btn" onclick="doSaveSettings()">ì €ì¥</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // Discord OAuth2 ì„¤ì • - ì‹¤ì œ ê°’ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”!
        // ============================================
        const CONFIG = {
            CLIENT_ID: '1441975322525434060',
            REDIRECT_URI: 'https://plugmarket.r-e.kr/',
            SCOPES: ['identify', 'guilds', 'bot'],
            API_BASE: 'https://discord.com/api/v10'
        };

        // ìƒíƒœ ê´€ë¦¬
        let currentUser = null;
        let userGuilds = [];
        let currentGuild = null;
        let accessToken = null;
        let myChart1 = null;
        let myChart2 = null;

        // ============================================
        // Discord OAuth2 ë¡œê·¸ì¸
        // ============================================
        function loginWithDiscord() {
            const params = new URLSearchParams({
                client_id: CONFIG.CLIENT_ID,
                redirect_uri: CONFIG.REDIRECT_URI,
                response_type: 'token',
                scope: CONFIG.SCOPES.join(' ')
            });
            window.location.href = `https://discord.com/api/oauth2/authorize?${params}`;
        }

        // URL fragmentì—ì„œ í† í° íŒŒì‹±
        function parseTokenFromUrl() {
            const fragment = window.location.hash.substring(1);
            const params = new URLSearchParams(fragment);
            return params.get('access_token');
        }

        // Discord API í˜¸ì¶œ
        async function discordApi(endpoint) {
            const res = await fetch(`${CONFIG.API_BASE}${endpoint}`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            if (!res.ok) throw new Error(`API Error: ${res.status}`);
            return res.json();
        }

        // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        async function fetchCurrentUser() {
            return await discordApi('/users/@me');
        }

        // ì‚¬ìš©ìì˜ ì„œë²„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        async function fetchUserGuilds() {
            return await discordApi('/users/@me/guilds');
        }

        // ì•„ë°”íƒ€ URL ìƒì„±
        function getAvatarUrl(user) {
            if (user.avatar) {
                return `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
            }
            return `https://cdn.discordapp.com/embed/avatars/${parseInt(user.discriminator || '0') % 5}.png`;
        }

        // ì„œë²„ ì•„ì´ì½˜ URL ìƒì„±
        function getGuildIconUrl(guild) {
            if (guild.icon) {
                return `https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png`;
            }
            return null;
        }

        // ============================================
        // UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤
        // ============================================
        function showServerSelect() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('serverSelectPage').style.display = 'block';
            document.getElementById('dashboardPage').style.display = 'none';
            
            // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
            document.getElementById('userName').textContent = currentUser.global_name || currentUser.username;
            const avatarEl = document.getElementById('userAvatar');
            avatarEl.innerHTML = `<img src="${getAvatarUrl(currentUser)}" alt="Avatar">`;
            
            renderServerGrid();
        }

        function renderServerGrid() {
            const grid = document.getElementById('serverGrid');
            // ê´€ë¦¬ì ê¶Œí•œì´ ìˆëŠ” ì„œë²„ë§Œ í•„í„°ë§ (ê¶Œí•œ ë¹„íŠ¸ 0x8 = ADMINISTRATOR)
            const adminGuilds = userGuilds.filter(g => (parseInt(g.permissions) & 0x8) === 0x8);
            
            if (adminGuilds.length === 0) {
                grid.innerHTML = '<p style="color: #b9bbbe;">ê´€ë¦¬ì ê¶Œí•œì´ ìˆëŠ” ì„œë²„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            grid.innerHTML = adminGuilds.map(guild => {
                const iconUrl = getGuildIconUrl(guild);
                const iconHtml = iconUrl 
                    ? `<img src="${iconUrl}" style="width:100%;height:100%;object-fit:cover;">`
                    : guild.name.charAt(0).toUpperCase();
                
                return `
                    <div class="server-card" onclick="selectGuild('${guild.id}')">
                        <div class="server-header">
                            <div class="server-icon">${iconHtml}</div>
                            <div class="server-info">
                                <h3>${escapeHtml(guild.name)}</h3>
                                <div class="online-badge">
                                    <div class="online-dot"></div>
                                    <span>ì˜¨ë¼ì¸</span>
                                </div>
                            </div>
                        </div>
                        <div class="server-footer">
                            <span>${guild.member_count || '-'} ë©¤ë²„</span>
                            <span class="bot-status active">ë´‡ í™œì„±</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function selectGuild(guildId) {
            currentGuild = userGuilds.find(g => g.id === guildId);
            if (!currentGuild) return;
            
            document.getElementById('serverSelectPage').style.display = 'none';
            document.getElementById('dashboardPage').style.display = 'block';
            
            // ì„ íƒëœ ì„œë²„ ì •ë³´ í‘œì‹œ
            const iconUrl = getGuildIconUrl(currentGuild);
            const iconEl = document.getElementById('selectedServerIcon');
            iconEl.innerHTML = iconUrl 
                ? `<img src="${iconUrl}" style="width:100%;height:100%;object-fit:cover;">`
                : currentGuild.name.charAt(0).toUpperCase();
            
            document.getElementById('selectedServerName').textContent = currentGuild.name;
            document.getElementById('selectedServerMembers').textContent = (currentGuild.member_count || '-') + ' ë©¤ë²„';
            
            // í†µê³„ ì—…ë°ì´íŠ¸ (ì‹¤ì œë¡œëŠ” ë´‡ APIì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)
            document.getElementById('totalMembers').textContent = currentGuild.member_count || '-';
            document.getElementById('onlineMembers').textContent = '-';
            document.getElementById('totalChannels').textContent = '-';
            document.getElementById('totalRoles').textContent = '-';
            
            makeCharts();
        }

        function goBackToServerSelect() {
            document.getElementById('dashboardPage').style.display = 'none';
            document.getElementById('serverSelectPage').style.display = 'block';
            currentGuild = null;
        }

        function doLogout() {
            accessToken = null;
            currentUser = null;
            userGuilds = [];
            currentGuild = null;
            // URLì—ì„œ í† í° ì œê±°
            window.history.replaceState({}, document.title, window.location.pathname);
            
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('serverSelectPage').style.display = 'none';
            document.getElementById('dashboardPage').style.display = 'none';
        }

        function changeSection(sname, el) {
            document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.getElementById('section' + sname.charAt(0).toUpperCase() + sname.slice(1)).classList.add('active');
            el.classList.add('active');
        }

        function doToggleSwitch(el) {
            el.classList.toggle('active');
        }

        function doUpdateSlider(el) {
            document.getElementById('volumeValue').textContent = el.value + '%';
        }

        function doSaveSettings() {
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (ì‹¤ì œ êµ¬í˜„ ì‹œ ë°±ì—”ë“œ API í˜¸ì¶œ í•„ìš”)');
        }

        function makeCharts() {
            const ctx1 = document.getElementById('chart1');
            const ctx2 = document.getElementById('chart2');
            if (myChart1) myChart1.destroy();
            if (myChart2) myChart2.destroy();
            
            myChart1 = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'],
                    datasets: [{
                        label: 'ë©”ì‹œì§€',
                        data: [2400, 1398, 9800, 3908, 4800, 3800, 4300],
                        backgroundColor: '#5865F2'
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
            
            myChart2 = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'],
                    datasets: [{
                        label: 'ë©¤ë²„',
                        data: [120, 135, 150, 148, 165, 170, 175],
                        borderColor: '#43b581',
                        tension: 0.4
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        // ============================================
        // ì•± ì´ˆê¸°í™”
        // ============================================
        async function initApp() {
            // URLì—ì„œ í† í° í™•ì¸
            const token = parseTokenFromUrl();
            
            if (token) {
                accessToken = token;
                // URL ì •ë¦¬ (í† í° ìˆ¨ê¸°ê¸°)
                window.history.replaceState({}, document.title, window.location.pathname);
                
                try {
                    // ì‚¬ìš©ì ì •ë³´ ë° ì„œë²„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                    currentUser = await fetchCurrentUser();
                    userGuilds = await fetchUserGuilds();
                    showServerSelect();
                } catch (err) {
                    console.error('Failed to fetch user data:', err);
                    alert('ë¡œê·¸ì¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    doLogout();
                }
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
